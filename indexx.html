<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gothwad Admin | Command Center</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-green: #0aff60;
            --neon-red: #ff3f3f;
            --neon-yellow: #facc15;
            --bg-dark: #050507;
            --surface: #0f0f13;
            --surface-glass: rgba(15, 15, 20, 0.9);
            --border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Outfit', sans-serif; }
        
        body { 
            background-color: var(--bg-dark); 
            background-image: 
                linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)),
                radial-gradient(circle at 0% 0%, rgba(0, 243, 255, 0.1), transparent 40%), 
                radial-gradient(circle at 100% 100%, rgba(188, 19, 254, 0.1), transparent 40%);
            color: var(--text-main); 
            font-size: 14px; 
            min-height: 100vh;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-blue); }

        /* --- LOGIN SCREEN --- */
        #login-container {
            display: flex; height: 100vh; align-items: center; justify-content: center; padding: 20px;
            background: radial-gradient(circle at 50% 50%, #1a1a20 0%, #000 100%);
        }
        .login-card {
            background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(20px);
            padding: 3rem; border-radius: 24px; border: 1px solid var(--border);
            box-shadow: 0 0 60px rgba(0, 243, 255, 0.05); width: 100%; max-width: 420px; text-align: center;
        }
        .login-card h2 {
            font-size: 2rem; margin-bottom: 2rem; letter-spacing: -1px;
            background: linear-gradient(to right, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* --- DASHBOARD LAYOUT --- */
        #dashboard-container { display: none; max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--surface-glass); backdrop-filter: blur(15px);
            padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);
            margin-bottom: 30px;
        }
        .brand { 
            font-weight: 800; font-size: 1.6rem; color: #fff; 
            display: flex; gap: 12px; align-items: center; letter-spacing: -0.5px;
        }
        .brand i { color: var(--neon-blue); filter: drop-shadow(0 0 10px var(--neon-blue)); }

        /* --- NAVIGATION TABS --- */
        .tabs { 
            display: flex; gap: 10px; margin-bottom: 30px; overflow-x: auto; padding-bottom: 5px; 
            background: rgba(255,255,255,0.02); padding: 10px; border-radius: 20px; border: 1px solid var(--border);
        }
        .tab-btn {
            background: transparent; border: none; color: var(--text-muted);
            padding: 12px 24px; border-radius: 12px; cursor: pointer; white-space: nowrap; 
            font-weight: 600; transition: 0.3s; display: flex; align-items: center; gap: 8px;
        }
        .tab-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .tab-btn.active { 
            background: var(--neon-blue); color: #000; box-shadow: 0 0 20px rgba(0, 243, 255, 0.4);
        }

        /* --- CONTENT SECTIONS --- */
        .section { display: none; animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- STATS GRID --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: var(--surface); border: 1px solid var(--border); padding: 25px; border-radius: 20px;
            position: relative; overflow: hidden; transition: 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.2); }
        .stat-card h4 { color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .stat-card .num { font-size: 2.5rem; font-weight: 700; color: #fff; }
        .stat-card i { position: absolute; right: 20px; bottom: 20px; font-size: 4rem; opacity: 0.05; }
        
        .stat-card.blue .num { color: var(--neon-blue); text-shadow: 0 0 20px rgba(0,243,255,0.3); }
        .stat-card.green .num { color: var(--neon-green); text-shadow: 0 0 20px rgba(10,255,96,0.3); }
        .stat-card.yellow .num { color: var(--neon-yellow); text-shadow: 0 0 20px rgba(250,204,21,0.3); }

        /* --- FORMS & CARDS --- */
        .form-card { background: var(--surface); padding: 30px; border-radius: 20px; border: 1px solid var(--border); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 10px; color: var(--text-muted); font-size: 0.95rem; font-weight: 500; }
        input, select, textarea {
            width: 100%; padding: 15px; background: #08080a; border: 1px solid #333; 
            color: #fff; border-radius: 12px; outline: none; transition: 0.3s; font-size: 1rem;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--neon-blue); box-shadow: 0 0 0 3px rgba(0,243,255,0.1); }
        textarea.code-editor { font-family: 'Courier New', monospace; color: var(--neon-green); line-height: 1.5; }

        .btn {
            background: linear-gradient(135deg, var(--neon-blue), #2563eb);
            color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; width: 100%; font-weight: 700; font-size: 1rem;
            transition: 0.3s;
        }
        .btn:hover { opacity: 0.9; box-shadow: 0 0 20px rgba(0, 243, 255, 0.4); transform: translateY(-2px); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: #ccc; }
        .btn-outline:hover { background: rgba(255,255,255,0.05); color: #fff; }

        /* --- LISTS --- */
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .filter-btn { 
            background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: #888; 
            padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 0.85rem;
        }
        .filter-btn.active { background: var(--neon-blue); color: #000; font-weight: 600; }

        .list-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 18px; background: rgba(255,255,255,0.02); border: 1px solid var(--border);
            border-radius: 16px; margin-bottom: 10px; transition: 0.2s;
        }
        .list-item:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.15); }
        .item-info { display: flex; gap: 18px; align-items: center; }
        .item-thumb { width: 55px; height: 55px; border-radius: 14px; background: #222; object-fit: cover; border: 1px solid #333; }
        .actions { display: flex; gap: 10px; }
        .action-btn { 
            width: 38px; height: 38px; border-radius: 10px; border: none; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
            background: rgba(255,255,255,0.05); color: #fff;
        }
        .action-btn:hover { transform: scale(1.1); background: #fff; color: #000; }
        .btn-del:hover { background: var(--neon-red); color: #fff; }

        /* --- TOGGLE & BADGES --- */
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--neon-green); }
        input:checked + .slider:before { transform: translateX(24px); }

        .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-apk { background: rgba(0, 243, 255, 0.1); color: var(--neon-blue); border: 1px solid rgba(0, 243, 255, 0.3); }
        .badge-game { background: rgba(10, 255, 96, 0.1); color: var(--neon-green); border: 1px solid rgba(10, 255, 96, 0.3); }

        .hidden { display: none; }
        
        /* Toast */
        #toast {
            visibility: hidden; min-width: 250px; background: #1a1a1a; border: 1px solid var(--neon-blue);
            color: #fff; text-align: center; border-radius: 12px; padding: 16px; position: fixed;
            bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

    </style>
</head>
<body>

    <!-- Login -->
    <div id="login-container">
        <div class="login-card">
            <h2>Gothwad Admin</h2>
            <div class="form-group"><input type="email" id="admin-email" placeholder="Admin ID"></div>
            <div class="form-group"><input type="password" id="admin-password" placeholder="Passcode"></div>
            <button class="btn" onclick="login()">Initialize System</button>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard-container">
        <header>
            <div class="brand"><i class="fa-solid fa-gamepad"></i> GOTHWAD COMMAND</div>
            <button onclick="logout()" class="btn btn-outline" style="width:auto; padding:10px 20px;">
                <i class="fa-solid fa-power-off"></i> Logout
            </button>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="showSection('home')"><i class="fa-solid fa-chart-pie"></i> Overview</button>
            <button class="tab-btn" onclick="showSection('manage-apps')"><i class="fa-solid fa-layer-group"></i> Apps & Games</button>
            <button class="tab-btn" onclick="showSection('banners')"><i class="fa-solid fa-image"></i> Banners</button>
            <button class="tab-btn" onclick="showSection('categories')"><i class="fa-solid fa-tags"></i> Categories</button>
            <button class="tab-btn" onclick="showSection('requests')"><i class="fa-solid fa-inbox"></i> Requests <span id="req-badge"></span></button>
            <button class="tab-btn" onclick="showSection('settings')"><i class="fa-solid fa-gear"></i> Settings</button>
        </div>

        <!-- 1. DASHBOARD OVERVIEW -->
        <div id="home" class="section active">
            <div class="stats-grid">
                <div class="stat-card blue">
                    <h4>Total Downloads (APKs)</h4>
                    <div class="num" id="stat-apk">0</div>
                    <i class="fa-brands fa-android"></i>
                </div>
                <div class="stat-card green">
                    <h4>Arcade Games (Instant)</h4>
                    <div class="num" id="stat-game">0</div>
                    <i class="fa-solid fa-gamepad"></i>
                </div>
                <div class="stat-card yellow">
                    <h4>Pending Requests</h4>
                    <div class="num" id="stat-reqs">0</div>
                    <i class="fa-solid fa-bell"></i>
                </div>
            </div>
            
            <div class="form-card">
                <h3 style="margin-bottom:15px;"><i class="fa-solid fa-bullhorn"></i> Global Announcement</h3>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="quick-msg" placeholder="Broadcast a message to all users...">
                    <button class="btn" style="width:150px;" onclick="saveQuickMsg()">Post Live</button>
                </div>
            </div>
        </div>

        <!-- 2. MANAGE APPS & GAMES -->
        <div id="manage-apps" class="section">
            <div class="list-header">
                <h3>Database Management</h3>
                <button class="btn" style="width:auto; padding:10px 25px;" onclick="showSection('add-app')"><i class="fa-solid fa-plus"></i> Add New</button>
            </div>
            
            <div class="filter-bar">
                <div class="filter-btn active" onclick="filterList('all', this)">All Items</div>
                <div class="filter-btn" onclick="filterList('apk', this)">APK Apps</div>
                <div class="filter-btn" onclick="filterList('game', this)">Arcade Games</div>
            </div>

            <div id="app-list" class="form-card" style="min-height:300px">Loading Database...</div>
        </div>

        <!-- 3. BANNERS -->
        <div id="banners" class="section">
            <div class="form-card">
                <h3>Hero Carousel</h3>
                <p style="color:#666; margin-bottom:20px;">Top sliding banners for the User Home tab.</p>
                <div style="display:flex; gap:15px; margin-bottom:30px;">
                    <input type="url" id="new-banner-url" placeholder="Image URL (e.g. https://imgur.com/...)">
                    <button class="btn" style="width:120px;" onclick="addBanner()">Add Slide</button>
                </div>
                <div id="banner-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:20px;"></div>
            </div>
        </div>

        <!-- 4. CATEGORIES -->
        <div id="categories" class="section">
            <div class="form-card">
                <h3>Category Tags</h3>
                <div style="display:flex; gap:15px; margin-bottom:30px; margin-top:10px;">
                    <input type="text" id="new-cat-input" placeholder="e.g. Action, Productivity, Tools">
                    <button class="btn" style="width:120px;" onclick="addCategory()">Create</button>
                </div>
                <div id="cat-list"></div>
            </div>
        </div>

        <!-- 5. REQUESTS -->
        <div id="requests" class="section">
            <h3>User Submissions</h3>
            <div id="req-list" class="form-card" style="margin-top:20px;">No pending requests.</div>
        </div>

        <!-- 6. ADD / EDIT APP FORM -->
        <div id="add-app" class="section">
            <div class="form-card" style="max-width:800px; margin:0 auto;">
                <h3 id="form-title" style="margin-bottom:25px; border-bottom:1px solid #333; padding-bottom:15px;">Add New Item</h3>
                <input type="hidden" id="edit-id">
                
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="a-title" placeholder="App Name">
                </div>
                
                <div class="form-group" style="background:#15151a; padding:15px; border-radius:12px; border:1px solid #333;">
                    <label style="color:var(--neon-blue);">Content Type</label>
                    <select id="a-type" onchange="toggleTypeFields()">
                        <option value="download">APK Application (Downloadable)</option>
                        <option value="instant">Arcade Game (Instant Play / HTML5)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <select id="a-cat"></select>
                </div>
                
                <!-- DYNAMIC FIELDS -->
                <div id="field-download" class="form-group">
                    <label>Download Link (APK / Store URL)</label>
                    <input type="url" id="a-link" placeholder="https://...">
                </div>

                <div id="field-instant" class="form-group hidden">
                    <label style="color:var(--neon-green)">HTML5 Source Code / iFrame</label>
                    <textarea id="a-html" class="code-editor" style="height:200px" placeholder='Paste your game code here, e.g. <iframe src="..."></iframe>'></textarea>
                </div>
                <!-- END DYNAMIC -->

                <div class="form-group"><label>Subtitle</label><input type="text" id="a-sub" placeholder="Short description"></div>
                <div class="form-group"><label>Logo URL</label><input type="url" id="a-logo"></div>
                <div class="form-group"><label>Description</label><textarea id="a-desc" style="height:100px"></textarea></div>
                <div class="form-group"><label>Screenshots (Comma separated URLs)</label><textarea id="a-screens" placeholder="url1, url2..."></textarea></div>

                <div style="display:flex; gap:15px; margin-top:30px;">
                    <button class="btn" onclick="submitApp()">Publish to Store</button>
                    <button class="btn btn-outline" onclick="resetForm()" style="display:none" id="cancel-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- 7. SETTINGS -->
        <div id="settings" class="section">
            <div class="form-card" style="max-width:800px; margin:0 auto;">
                <h3 style="margin-bottom:25px;">Store Configuration</h3>
                
                <div class="form-group" style="background:rgba(255,63,63,0.1); padding:20px; border-radius:12px; border:1px solid rgba(255,63,63,0.3);">
                    <label style="display:flex; justify-content:space-between; align-items:center; margin:0; cursor:pointer;">
                        <div>
                            <span style="color:var(--neon-red); font-weight:bold; font-size:1.1rem;"><i class="fa-solid fa-lock"></i> Maintenance Mode</span>
                            <p style="font-size:0.85rem; color:#aaa; margin-top:5px;">Locks the User Panel with an "Under Maintenance" screen.</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="maintenance-toggle" onchange="toggleMaintenance()">
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                
                <div class="form-group"><label>Store Name</label><input type="text" id="s-name"></div>
                <div class="form-group"><label>Store Logo URL</label><input type="text" id="s-logo"></div>
                <div class="form-group"><label>UPI ID (For Donations)</label><input type="text" id="s-upi"></div>
                
                <button class="btn" onclick="saveSettings()" style="margin-top:10px;">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="toast">Notification</div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD7eCC_96q2aTBFsPQJphwyCaqYukR7XDM",
            authDomain: "gothwad-store.firebaseapp.com",
            databaseURL: "https://gothwad-store-default-rtdb.firebaseio.com",
            projectId: "gothwad-store",
            storageBucket: "gothwad-store.firebasestorage.app",
            messagingSenderId: "566532674284",
            appId: "1:566532674284:web:2229efeed2da645238cbc9",
            measurementId: "G-Q7EQ44CPE6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- GLOBAL EXPORTS ---
        window.login = login; window.logout = logout; window.showSection = showSection;
        window.submitApp = submitApp; window.deleteApp = deleteApp; window.editApp = editApp;
        window.resetForm = resetForm; window.saveSettings = saveSettings; window.saveQuickMsg = saveQuickMsg;
        window.toggleTypeFields = toggleTypeFields; window.addCategory = addCategory; window.deleteCategory = deleteCategory;
        window.addBanner = addBanner; window.deleteBanner = deleteBanner; window.toggleMaintenance = toggleMaintenance;
        window.toggleFeature = toggleFeature; window.approveReq = approveReq; window.rejectReq = rejectReq;
        window.filterList = filterList;

        let allAppsCache = [];
        let currentFilter = 'all';

        // --- AUTH ---
        onAuthStateChanged(auth, u => {
            if(u) {
                document.getElementById('login-container').style.display='none';
                document.getElementById('dashboard-container').style.display='block';
                initData();
            } else {
                document.getElementById('login-container').style.display='flex';
                document.getElementById('dashboard-container').style.display='none';
            }
        });

        function login() {
            const e = document.getElementById('admin-email').value;
            const p = document.getElementById('admin-password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => showToast(err.message));
        }
        function logout() { signOut(auth); }

        function initData() {
            loadApps(); loadCategories(); loadBanners(); loadRequests(); loadSettings();
        }

        // --- APPS LOGIC ---
        function toggleTypeFields() {
            const type = document.getElementById('a-type').value;
            if(type === 'instant') {
                document.getElementById('field-download').classList.add('hidden');
                document.getElementById('field-instant').classList.remove('hidden');
            } else {
                document.getElementById('field-download').classList.remove('hidden');
                document.getElementById('field-instant').classList.add('hidden');
            }
        }

        function submitApp() {
            const id = document.getElementById('edit-id').value;
            const title = document.getElementById('a-title').value;
            const type = document.getElementById('a-type').value;
            const cat = document.getElementById('a-cat').value;
            const logo = document.getElementById('a-logo').value;
            const link = document.getElementById('a-link').value;
            const html = document.getElementById('a-html').value;
            const sub = document.getElementById('a-sub').value;
            const desc = document.getElementById('a-desc').value;
            const screens = document.getElementById('a-screens').value.split(',').filter(s=>s.trim()!=='');

            if(!title) return showToast("Title required");
            if(type === 'download' && !link) return showToast("Download Link required");
            if(type === 'instant' && !html) return showToast("HTML Source required");

            const data = { 
                title, subtitle:sub, category:cat, logo, description:desc, screenshots:screens,
                appType: type,
                downloadLink: (type === 'download' ? link : ""),
                htmlSource: (type === 'instant' ? html : ""),
                updatedAt: Date.now()
            };

            if(id) update(ref(db, 'apps/'+id), data).then(()=>{ showToast("Updated"); resetForm(); showSection('manage-apps'); });
            else push(ref(db, 'apps'), data).then(()=>{ showToast("Published"); resetForm(); showSection('manage-apps'); });
        }

        function loadApps() {
            onValue(ref(db, 'apps'), snap => {
                const data = snap.val();
                allAppsCache = [];
                let apkCount = 0;
                let gameCount = 0;

                if(data) {
                    Object.entries(data).forEach(([k,v]) => {
                        v.id = k;
                        allAppsCache.push(v);
                        if(v.appType === 'instant') gameCount++; else apkCount++;
                    });
                }
                
                document.getElementById('stat-apk').innerText = apkCount;
                document.getElementById('stat-game').innerText = gameCount;
                renderAppList();
            });
        }

        function renderAppList() {
            const list = document.getElementById('app-list');
            list.innerHTML = "";
            
            const filtered = allAppsCache.filter(item => {
                if(currentFilter === 'all') return true;
                if(currentFilter === 'apk') return item.appType !== 'instant';
                if(currentFilter === 'game') return item.appType === 'instant';
            });

            if(filtered.length === 0) { list.innerHTML = "<p style='text-align:center;color:#666'>No items found.</p>"; return; }

            filtered.forEach(v => {
                const isGame = v.appType === 'instant';
                const badge = isGame 
                    ? `<span class="badge badge-game"><i class="fa-solid fa-gamepad"></i> ARCADE</span>` 
                    : `<span class="badge badge-apk"><i class="fa-brands fa-android"></i> APK</span>`;
                
                const starColor = v.isFeatured ? "#fbbf24" : "#444";

                list.innerHTML += `
                    <div class="list-item">
                        <div class="item-info">
                            <img src="${v.logo}" class="item-thumb" onerror="this.src='https://via.placeholder.com/50'">
                            <div>
                                <b style="font-size:1rem">${v.title}</b> ${badge}<br>
                                <span style="font-size:0.85rem; color:#888;">${v.category}</span>
                            </div>
                        </div>
                        <div class="actions">
                            <button class="action-btn" onclick="toggleFeature('${v.id}', ${v.isFeatured})"><i class="fa-solid fa-star" style="color:${starColor}"></i></button>
                            <button class="action-btn" onclick="editApp('${v.id}')"><i class="fa-solid fa-pen"></i></button>
                            <button class="action-btn btn-del" onclick="deleteApp('${v.id}')"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`;
            });
        }

        function filterList(type, el) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            renderAppList();
        }

        function editApp(id) {
            const d = allAppsCache.find(x => x.id === id);
            if(!d) return;
            
            document.getElementById('edit-id').value = id;
            document.getElementById('a-title').value = d.title;
            document.getElementById('a-sub').value = d.subtitle;
            document.getElementById('a-cat').value = d.category;
            document.getElementById('a-logo').value = d.logo;
            document.getElementById('a-desc').value = d.description;
            document.getElementById('a-screens').value = d.screenshots ? d.screenshots.join(',') : '';

            document.getElementById('a-type').value = d.appType || 'download';
            toggleTypeFields();
            
            if(d.appType === 'instant') document.getElementById('a-html').value = d.htmlSource || "";
            else document.getElementById('a-link').value = d.downloadLink || "";

            document.getElementById('form-title').innerText = "Edit Item";
            document.getElementById('cancel-btn').style.display = 'inline-block';
            showSection('add-app');
        }

        function deleteApp(id) { if(confirm("Permanently delete this item?")) remove(ref(db, 'apps/'+id)); }
        function toggleFeature(id, c) { update(ref(db, 'apps/'+id), { isFeatured: !c }); }

        function resetForm() {
            document.getElementById('edit-id').value = "";
            document.getElementById('a-title').value = "";
            document.getElementById('a-link').value = "";
            document.getElementById('a-html').value = "";
            document.getElementById('a-type').value = "download";
            toggleTypeFields();
            document.getElementById('form-title').innerText = "Add New Item";
            document.getElementById('cancel-btn').style.display = 'none';
        }

        // --- BANNERS ---
        function loadBanners() {
            onValue(ref(db, 'banners'), snap => {
                const div = document.getElementById('banner-list');
                div.innerHTML = "";
                const data = snap.val();
                if(data) {
                    Object.entries(data).forEach(([k,v]) => {
                        div.innerHTML += `
                            <div style="position:relative;">
                                <img src="${v.url}" style="width:100%; height:140px; object-fit:cover; border-radius:12px; border:1px solid #333;">
                                <button onclick="deleteBanner('${k}')" style="position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.7); color:#ff4d4d; border:none; border-radius:6px; padding:4px 8px; cursor:pointer;"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        `;
                    });
                }
            });
        }
        function addBanner() {
            const url = document.getElementById('new-banner-url').value;
            if(url) push(ref(db, 'banners'), { url: url }).then(() => { document.getElementById('new-banner-url').value=""; showToast("Banner added"); });
        }
        function deleteBanner(k) { remove(ref(db, 'banners/'+k)); }

        // --- CATEGORIES ---
        function loadCategories() {
            onValue(ref(db, 'categories'), snap => {
                const list = document.getElementById('cat-list');
                const select = document.getElementById('a-cat');
                list.innerHTML = ""; select.innerHTML = "";
                const data = snap.val();
                
                if(!data) { addOption("App"); addOption("Game"); return; }
                
                Object.entries(data).forEach(([k,v]) => {
                    list.innerHTML += `
                        <div class="list-item" style="padding:12px;">
                            <b>${v.name}</b>
                            <button class="action-btn btn-del" onclick="deleteCategory('${k}')"><i class="fa-solid fa-xmark"></i></button>
                        </div>`;
                    addOption(v.name);
                });
            });
        }
        function addOption(name) {
            const o = document.createElement('option'); o.value=name; o.innerText=name;
            document.getElementById('a-cat').appendChild(o);
        }
        function addCategory() {
            const v = document.getElementById('new-cat-input').value;
            if(v) push(ref(db, 'categories'), {name:v}).then(()=>{ document.getElementById('new-cat-input').value=""; });
        }
        function deleteCategory(k) { remove(ref(db, 'categories/'+k)); }

        // --- REQUESTS ---
        function loadRequests() {
            onValue(ref(db, 'requests'), snap => {
                const div = document.getElementById('req-list');
                const data = snap.val();
                if(!data) { 
                    div.innerHTML = "<p style='color:#666'>No pending requests.</p>"; 
                    document.getElementById('stat-reqs').innerText = "0";
                    document.getElementById('req-badge').innerText = "";
                    return; 
                }
                let c = 0;
                div.innerHTML = "";
                Object.entries(data).forEach(([k,v]) => {
                    c++;
                    div.innerHTML += `
                        <div class="list-item">
                            <div class="item-info">
                                <img src="${v.logo}" class="item-thumb">
                                <div>
                                    <b>${v.title}</b> <span class="badge badge-apk">${v.category}</span><br>
                                    <span style="font-size:0.8rem; color:var(--neon-blue)">${v.userEmail}</span>
                                </div>
                            </div>
                            <div class="actions">
                                <button class="action-btn" style="color:var(--neon-green)" onclick="approveReq('${k}')"><i class="fa-solid fa-check"></i></button>
                                <button class="action-btn" style="color:var(--neon-red)" onclick="rejectReq('${k}')"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                        </div>`;
                });
                document.getElementById('stat-reqs').innerText = c;
                document.getElementById('req-badge').innerText = `(${c})`;
            });
        }
        
        function approveReq(id) {
            get(ref(db, 'requests/'+id)).then(snap => {
                const d = snap.val();
                // Default to 'download' type. Admin can edit to 'instant' later.
                push(ref(db, 'apps'), {
                    title: d.title, category: d.category, logo: d.logo, downloadLink: d.downloadLink || "", 
                    description: "Submitted by user.", appType: 'download', createdAt: Date.now()
                }).then(() => {
                    remove(ref(db, 'requests/'+id));
                    showToast("Approved & Published!");
                });
            });
        }
        function rejectReq(id) { if(confirm("Reject submission?")) remove(ref(db, 'requests/'+id)); }

        // --- SETTINGS ---
        function loadSettings() {
            onValue(ref(db, 'settings'), snap => {
                const d = snap.val();
                if(d) {
                    document.getElementById('s-name').value = d.storeName || "";
                    document.getElementById('s-logo').value = d.storeLogo || "";
                    document.getElementById('s-upi').value = d.upiId || "";
                    document.getElementById('quick-msg').value = d.announcement || "";
                    document.getElementById('maintenance-toggle').checked = d.maintenance || false;
                }
            });
        }
        function saveSettings() {
            update(ref(db, 'settings'), {
                storeName: document.getElementById('s-name').value,
                storeLogo: document.getElementById('s-logo').value,
                upiId: document.getElementById('s-upi').value
            }).then(() => showToast("Settings Saved"));
        }
        function saveQuickMsg() { update(ref(db, 'settings'), { announcement: document.getElementById('quick-msg').value }).then(()=>showToast("Posted")); }
        function toggleMaintenance() { update(ref(db, 'settings'), { maintenance: document.getElementById('maintenance-toggle').checked }); }

        // --- UTILS ---
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            const tabs = ['home', 'manage-apps', 'banners', 'categories', 'requests', 'settings'];
            const idx = tabs.indexOf(id);
            if(idx > -1) document.querySelectorAll('.tab-btn')[idx].classList.add('active');
        }
        function showToast(m) { const t=document.getElementById("toast"); t.innerText=m; t.className="show"; setTimeout(()=>t.className="",3000); }
    </script>
</body>
</html>
